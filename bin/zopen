#!/bin/sh
#
# zopen wrapper script to allow single point of entry to zopen
# tooling
#
ZOPEN_DONT_PROCESS_CONFIG=1 
#
# All zopen-* scripts MUST start with this code to maintain consistency
#
setupMyself()
{
  ME=$(basename $0)
  MYDIR="$( cd "$(dirname "$0")" >/dev/null 2>&1 && pwd -P )"
  INCDIR="${MYDIR}/../include"
  if ! [ -d "${INCDIR}" ] && ! [ -f "${INCDIR}/common.sh" ]; then
    echo "Internal Error. Unable to find common.sh file to source" >&2
    exit 8
  fi
  . "${INCDIR}/common.sh"
}
setupMyself


printHelp(){
cat << HELPDOC
zopen is a utility for mangaging a z/OS Open Tools environment.

Usage: zopen [COMMAND] [OPTION] [PARAMETERS]...

Command:
  init              generate \$rootfs/etc/zopen-config, creates file 
                    structure and bootstraps
  build             invokes the build script
  promote           promote  a z/OS Open Tools environment to a new 
                    location
  download          downloads z/OS Open Tools package(s)
  install           installs z/OS Open Tools package(s))
  generate          generate a zopen project
  update-cacert     update the cacert.pem file
  upgrade           upgrades already installed tools
  list              lists information about z/OS Open Tools packages
  query             queries z/OS Open Tools packages
  search            searches remote repo for z/OS Open Tools package
  remove            removes installed z/OS Open Tools packages
  alt               switch local versions of z/OS Open Tools packages
  clean             cleans various aspects of z/OS Open Tools packages

Option:
  -v, --verbose     run in verbose mode
  -h,-?, --help     display this help and exit

Examples:
  zopen alt foo     list the available alternatives for package 'foo'
  zopen --help      display help for zopen
  zopen install foo 
                    install package foo
  zopen alt --select foo
                    list the available alternatives for package 'foo'
                    and allow the user to select an alternative version



Report bugs at https://github.com/ZOSOpenTools/meta/issues .

HELPDOC
}


export PATH="${MYDIR}:${PATH}"

subopts=""
subcmd=""
help=false
version=false

for arg in $*; do
  case "$arg" in
    "alt"|"build"|"clean"|"promote"|"generate"|"init"|"install"|\
    "query"|"remove"|"update-cacert"|"upgrade")
      subcmd="zopen-$arg"
      ;;
    "list")
      subcmd='zopen-query'
      subopts="${subopts} --list"
      ;;
    "search")
      subcmd='zopen-query'
      subopts="${subopts} --remote-search"
      ;;
    "--version")
      version=true
      ;;
    "help" | "--help" | "-?")
      help=true
      ;;
    *)
      # let unknown stuff through
      subopts="${subopts} ${arg}"
      ;;
  esac
done

if [ "x${subcmd}" = "x" ]; then
  if $help; then
    printHelp
    exit 0
  elif $version; then
    : # fall through
  else
    printHelp
    exit 4
  fi
fi

if $help; then
  subopts="--help"
fi

if $version; then
  if [ "x${subcmd}" = "x" ]; then
    subopts="$ME"
  else
    subopts="${subcmd}"
  fi
  subcmd='zopen-version'
fi

${subcmd} ${subopts}
